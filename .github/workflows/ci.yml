name: CloudShop CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  FRONTEND_SIZE_LIMIT: 70
  GATEWAY_SIZE_LIMIT: 150
  AUTH_SIZE_LIMIT: 150
  PRODUCTS_SIZE_LIMIT: 180
  ORDERS_SIZE_LIMIT: 30

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend
        run: docker build -t tp-final-frontend ./frontend

      - name: Build API Gateway
        run: docker build -t tp-final-api-gateway ./api-gateway

      - name: Build Auth Service
        run: docker build -t tp-final-auth-service ./auth-service

      - name: Build Products API
        run: docker build -t tp-final-products-api ./products-api

      - name: Build Orders API
        run: docker build -t tp-final-orders-api ./orders-api

      - name: Save images
        run: |
          docker save tp-final-frontend tp-final-api-gateway tp-final-auth-service tp-final-products-api tp-final-orders-api -o images.tar

      - name: Upload images artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: images.tar
          retention-days: 1

  size-check:
    name: Image Size Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load images
        run: docker load -i images.tar

      - name: Check image sizes
        run: |
          echo "## Docker Image Size Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          EXIT_CODE=0
          
          check_size() {
            IMAGE=$1
            LIMIT=$2
            SIZE_B=$(docker image inspect $IMAGE --format='{{.Size}}' 2>/dev/null || echo "0")
            SIZE_MB=$((SIZE_B / 1048576))
            if [ "$SIZE_MB" -le "$LIMIT" ]; then
              echo "| $IMAGE | ${SIZE_MB}MB | ${LIMIT}MB | ✅ PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $IMAGE | ${SIZE_MB}MB | ${LIMIT}MB | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY
              EXIT_CODE=1
            fi
          }
          
          echo "| Image | Size | Limit | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          check_size "tp-final-frontend" ${{ env.FRONTEND_SIZE_LIMIT }}
          check_size "tp-final-api-gateway" ${{ env.GATEWAY_SIZE_LIMIT }}
          check_size "tp-final-auth-service" ${{ env.AUTH_SIZE_LIMIT }}
          check_size "tp-final-products-api" ${{ env.PRODUCTS_SIZE_LIMIT }}
          check_size "tp-final-orders-api" ${{ env.ORDERS_SIZE_LIMIT }}
          
          exit $EXIT_CODE

  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load images
        run: docker load -i images.tar

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Scan Frontend
        run: trivy image --severity HIGH,CRITICAL --exit-code 0 tp-final-frontend

      - name: Scan API Gateway
        run: trivy image --severity HIGH,CRITICAL --exit-code 0 tp-final-api-gateway

      - name: Scan Auth Service
        run: trivy image --severity HIGH,CRITICAL --exit-code 0 tp-final-auth-service

      - name: Scan Products API
        run: trivy image --severity HIGH,CRITICAL --exit-code 0 tp-final-products-api

      - name: Scan Orders API
        run: trivy image --severity HIGH,CRITICAL --exit-code 0 tp-final-orders-api

      - name: Generate Security Summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scans completed for all images." >> $GITHUB_STEP_SUMMARY
          echo "Severity filter: HIGH, CRITICAL" >> $GITHUB_STEP_SUMMARY

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load images
        run: docker load -i images.tar

      - name: Start services
        run: |
          docker compose up -d
          sleep 30

      - name: Health checks
        run: |
          echo "## Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          check_health() {
            NAME=$1
            URL=$2
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
            if [[ "$HTTP_CODE" == 2* ]]; then
              echo "| $NAME | ✅ UP ($HTTP_CODE) |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $NAME | ❌ DOWN ($HTTP_CODE) |" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          check_health "Frontend" "http://localhost:3000"
          check_health "API Gateway" "http://localhost:4000/health"
          check_health "Auth Service" "http://localhost:4001/health"
          check_health "Products API" "http://localhost:4002/health"
          check_health "Orders API" "http://localhost:4003/health"

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build, size-check, security-scan, integration-test]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# CloudShop CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Size Check | ${{ needs.size-check.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test | ${{ needs.integration-test.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
