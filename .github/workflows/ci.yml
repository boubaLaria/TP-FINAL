name: CloudShop CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  FRONTEND_SIZE_LIMIT: 70
  GATEWAY_SIZE_LIMIT: 150
  AUTH_SIZE_LIMIT: 150
  PRODUCTS_SIZE_LIMIT: 180
  ORDERS_SIZE_LIMIT: 30

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend
        run: docker build -t tp-final-frontend ./frontend

      - name: Build API Gateway
        run: docker build -t tp-final-api-gateway ./api-gateway

      - name: Build Auth Service
        run: docker build -t tp-final-auth-service ./auth-service

      - name: Build Products API
        run: docker build -t tp-final-products-api ./products-api

      - name: Build Orders API
        run: docker build -t tp-final-orders-api ./orders-api

      - name: Save images
        run: |
          docker save tp-final-frontend tp-final-api-gateway tp-final-auth-service tp-final-products-api tp-final-orders-api -o images.tar

      - name: Upload images artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: images.tar
          retention-days: 1

  size-check:
    name: Image Size Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load images
        run: docker load -i images.tar

      - name: Check image sizes
        run: |
          chmod +x scripts/check-image-sizes.sh
          ./scripts/check-image-sizes.sh

  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load images
        run: docker load -i images.tar

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Run Trivy Security Scan
        run: |
          chmod +x scripts/trivy-scan.sh
          SEVERITY="HIGH,CRITICAL" SKIP_SARIF="true" OUTPUT_DIR="./scripts/trivy-reports" ./scripts/trivy-scan.sh || exit 0

      - name: Upload Scan Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: scripts/trivy-reports/
          retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load images
        run: docker load -i images.tar

      - name: Start services
        run: |
          docker compose up -d
          sleep 30

      - name: Health checks
        run: |
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build, size-check, security-scan, integration-test]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# CloudShop CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Size Check | ${{ needs.size-check.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test | ${{ needs.integration-test.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
